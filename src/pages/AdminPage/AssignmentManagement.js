import React, { useState, useEffect } from "react";
import AdminLayout from "../../layouts/AdminLayout";
import APIService from "../../services/APIService";
import "./AssignmentManagement.css";

const AssignmentManagement = () => {
  const [assignments, setAssignments] = useState([]);
  const [sections, setSections] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterSection, setFilterSection] = useState('ALL');
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    sectionId: '',
    startDate: '',
    endDate: '',
    assignmentNumber: ''
  });

  useEffect(() => {
    fetchAssignments();
    fetchSections();
  }, []);

  const fetchAssignments = async () => {
    try {
      setLoading(true);
      
      // 1. Î®ºÏ†Ä dashboardÏóêÏÑú Î∂ÑÎ∞ò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const dashboardResponse = await APIService.getInstructorDashboard();
      const sectionsData = dashboardResponse?.data || [];
      setSections(sectionsData);
      
      // 2. Í∞Å Î∂ÑÎ∞òÏùò Í≥ºÏ†úÎì§ÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Ï°∞ÌöåÌïòÍ≥† Î¨∏Ï†ú ÏàòÎèÑ Ìï®Íªò Ï°∞Ìöå
      let allAssignments = [];
      for (const section of sectionsData) {
        try {
          const sectionAssignments = await APIService.getAssignmentsBySection(section.sectionId);
          
          // Í∞Å Í≥ºÏ†úÏùò Î¨∏Ï†ú Ïàò Ï°∞Ìöå
          const assignmentsWithDetails = await Promise.all(
            (sectionAssignments || []).map(async (assignment) => {
              try {
                const problems = await APIService.getAssignmentProblems(section.sectionId, assignment.id);
                return {
                  ...assignment,
                  sectionName: section.courseTitle,
                  sectionId: section.sectionId,
                  problemCount: problems?.length || 0,
                  problems: problems || [],
                  // API ÏùëÎãµÏóêÏÑú endDateÎ•º dueDateÎ°ú Îß§Ìïë
                  dueDate: assignment.endDate,
                  // ÏûÑÏãú Ï†úÏ∂ú ÌÜµÍ≥Ñ (Ïã§Ï†úÎ°úÎäî Î≥ÑÎèÑ API ÌïÑÏöî)
                  submissionCount: 0,
                  totalStudents: 25 // ÏûÑÏãúÍ∞í
                };
              } catch (error) {

                return {
                  ...assignment,
                  sectionName: section.courseTitle,
                  sectionId: section.sectionId,
                  problemCount: 0,
                  problems: [],
                  dueDate: assignment.endDate,
                  submissionCount: 0,
                  totalStudents: 25
                };
              }
            })
          );
          
          allAssignments = [...allAssignments, ...assignmentsWithDetails];
        } catch (error) {
          // Î∂ÑÎ∞ò Í≥ºÏ†ú Ï°∞Ìöå Ïã§Ìå® Ïãú Î¨¥Ïãú
        }
      }
      
      setAssignments(allAssignments);
      setLoading(false);
    } catch (error) {
      setAssignments([]);
      setLoading(false);
    }
  };

  const fetchSections = async () => {
    // fetchAssignmentsÏóêÏÑú Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê®
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const resetForm = () => {
    setFormData({
      title: '',
      description: '',
      sectionId: '',
      startDate: '',
      endDate: '',
      assignmentNumber: ''
    });
  };

  const handleAddAssignment = () => {
    setShowAddModal(true);
    resetForm();
  };

  const handleCloseModal = () => {
    setShowAddModal(false);
    resetForm();
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      // Î∞±ÏóîÎìú API Ìò∏Ï∂ú (Íµ¨ÌòÑ ÏòàÏ†ï)
      console.log('Í≥ºÏ†ú ÏÉùÏÑ± ÏöîÏ≤≠:', formData);
      alert('Í≥ºÏ†úÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. (Î∞±ÏóîÎìú API Íµ¨ÌòÑ ÌïÑÏöî)');
      handleCloseModal();
      fetchAssignments(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
    } catch (error) {
      alert('Í≥ºÏ†ú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const handleEdit = (assignment) => {
    console.log('Í≥ºÏ†ú ÏàòÏ†ï:', assignment);
    alert('Í≥ºÏ†ú ÏàòÏ†ï Í∏∞Îä•ÏùÄ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
  };

  const handleDelete = async (assignmentId) => {
    if (window.confirm('Ï†ïÎßêÎ°ú Ïù¥ Í≥ºÏ†úÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      try {
        console.log('Í≥ºÏ†ú ÏÇ≠Ï†ú:', assignmentId);
        alert('Í≥ºÏ†ú ÏÇ≠Ï†ú Í∏∞Îä•ÏùÄ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
      } catch (error) {
        alert('Í≥ºÏ†ú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
  };

  const getDifficultyColor = (difficulty) => {
    switch (difficulty.toLowerCase()) {
      case 'easy': return '#52c41a';
      case 'medium': return '#faad14';
      case 'hard': return '#ff4d4f';
      default: return '#666';
    }
  };

  const getSubmissionRate = (submitted, total) => {
    return total > 0 ? Math.round((submitted / total) * 100) : 0;
  };

  // ÌïÑÌÑ∞ÎßÅÎêú Í≥ºÏ†ú Î™©Î°ù
  const filteredAssignments = assignments.filter(assignment => {
    const matchesSearch = assignment.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         assignment.description.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesSection = filterSection === 'ALL' || assignment.sectionName.includes(filterSection);
    return matchesSearch && matchesSection;
  });

  // Í≥†Ïú†Ìïú ÏÑπÏÖò Î™©Î°ù Ï∂îÏ∂ú
  const uniqueSections = [...new Set(assignments.map(assignment => assignment.sectionName))].filter(Boolean);

  if (loading) {
    return (
      <AdminLayout>
        <div className="loading-container">
          <div className="loading-spinner"></div>
          <p>Í≥ºÏ†ú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
      </AdminLayout>
    );
  }

  return (
    <AdminLayout>
      <div className="assignment-management">
        <div className="page-header">
          <h1 className="page-title">Í≥ºÏ†ú Í¥ÄÎ¶¨</h1>
          <div className="header-actions">
            <div className="header-stats">
              <span className="stat-badge">Ï¥ù {assignments.length}Í∞ú</span>
              <span className="stat-badge active">{uniqueSections.length}Í∞ú Î∂ÑÎ∞ò</span>
            </div>
            <button 
              className="btn-primary"
              onClick={handleAddAssignment}
            >
              <span>‚ûï</span>
              ÏÉà Í≥ºÏ†ú ÎßåÎì§Í∏∞
            </button>
          </div>
        </div>

        <div className="filters-section">
          <div className="search-box">
            <input
              type="text"
              placeholder="Í≥ºÏ†úÎ™Ö, ÏÑ§Î™ÖÏúºÎ°ú Í≤ÄÏÉâ..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="search-input"
            />
            <span className="search-icon">üîç</span>
          </div>
          
          <select
            value={filterSection}
            onChange={(e) => setFilterSection(e.target.value)}
            className="section-filter"
          >
            <option value="ALL">Î™®Îì† Î∂ÑÎ∞ò</option>
            {uniqueSections.map((section, index) => (
              <option key={index} value={section}>{section}</option>
            ))}
          </select>
        </div>

        <div className="assignments-list">
          {filteredAssignments.map((assignment) => (
            <div key={assignment.id} className="assignment-card">
              <div className="assignment-header">
                <div className="assignment-info">
                  <h3 className="assignment-title">{assignment.title}</h3>
                  <p className="assignment-course">{assignment.sectionName}</p>
                </div>
                <div className="assignment-actions">
                  <button 
                    className="btn-icon-small edit"
                    onClick={() => handleEdit(assignment)}
                    title="ÏàòÏ†ï"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button 
                    className="btn-icon-small delete"
                    onClick={() => handleDelete(assignment.id)}
                    title="ÏÇ≠Ï†ú"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </div>
              
              <p className="assignment-description">{assignment.description}</p>
              
              <div className="assignment-stats">
                <div className="stat-item">
                  <span className="stat-label">ÎßàÍ∞êÏùº:</span>
                  <span className="stat-value due-date">
                    {assignment.dueDate ? new Date(assignment.dueDate).toLocaleDateString('ko-KR') : 'ÎØ∏ÏÑ§Ï†ï'}
                  </span>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Î¨∏Ï†ú Ïàò:</span>
                  <span className="stat-value">{assignment.problemCount || 0}Í∞ú</span>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Ï†úÏ∂úÎ•†:</span>
                  <span className="stat-value submission-rate">
                    {assignment.submissionCount || 0}/{assignment.totalStudents || 0} 
                    ({getSubmissionRate(assignment.submissionCount || 0, assignment.totalStudents || 0)}%)
                  </span>
                </div>
              </div>

              <div className="problems-section">
                <h4 className="problems-title">Î¨∏Ï†ú Î™©Î°ù ({assignment.problemCount || 0}Í∞ú)</h4>
                <div className="problems-list">
                  {assignment.problems && assignment.problems.length > 0 ? (
                    assignment.problems.map((problem, index) => (
                      <div key={problem.id || index} className="problem-item">
                        <span className="problem-number">{index + 1}.</span>
                        <span className="problem-title">{problem.title}</span>
                        {problem.difficulty && (
                          <span 
                            className="problem-difficulty"
                            style={{ color: getDifficultyColor(problem.difficulty) }}
                          >
                            [{problem.difficulty}]
                          </span>
                        )}
                        {problem.domjudgeProblemId && (
                          <span className="problem-id">ID: {problem.domjudgeProblemId}</span>
                        )}
                      </div>
                    ))
                  ) : (
                    <p className="no-problems">Îì±Î°ùÎêú Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                  )}
                </div>
              </div>

              <div className="progress-bar">
                <div 
                  className="progress-fill"
                  style={{ 
                    width: `${getSubmissionRate(assignment.submissionCount, assignment.totalStudents)}%` 
                  }}
                ></div>
              </div>
            </div>
          ))}
          {filteredAssignments.length === 0 && (
            <div className="no-assignments">
              <div className="no-assignments-message">
                <span className="no-assignments-icon">üìù</span>
                <p>
                  {searchTerm || filterSection !== 'ALL' 
                    ? 'Í≤ÄÏÉâ Ï°∞Í±¥Ïóê ÎßûÎäî Í≥ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.' 
                    : 'ÏïÑÏßÅ ÏÉùÏÑ±Îêú Í≥ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.'
                  }
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Í≥ºÏ†ú Ï∂îÍ∞Ä Î™®Îã¨ */}
        {showAddModal && (
          <div className="modal-overlay">
            <div className="modal-content">
              <div className="modal-header">
                <h2>ÏÉà Í≥ºÏ†ú ÎßåÎì§Í∏∞</h2>
                <button 
                  className="modal-close"
                  onClick={handleCloseModal}
                >
                  ‚úï
                </button>
              </div>
              
              <form onSubmit={handleSubmit} className="assignment-form">
                <div className="form-row">
                  <div className="form-group">
                    <label htmlFor="title">Í≥ºÏ†úÎ™Ö *</label>
                    <input
                      type="text"
                      id="title"
                      name="title"
                      value={formData.title}
                      onChange={handleInputChange}
                      placeholder="Í≥ºÏ†úÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                      required
                    />
                  </div>
                  
                  <div className="form-group">
                    <label htmlFor="assignmentNumber">Í≥ºÏ†ú Î≤àÌò∏</label>
                    <input
                      type="text"
                      id="assignmentNumber"
                      name="assignmentNumber"
                      value={formData.assignmentNumber}
                      onChange={handleInputChange}
                      placeholder="Ïòà: HW1, Assignment1"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label htmlFor="sectionId">Î∂ÑÎ∞ò ÏÑ†ÌÉù *</label>
                  <select
                    id="sectionId"
                    name="sectionId"
                    value={formData.sectionId}
                    onChange={handleInputChange}
                    required
                  >
                    <option value="">Î∂ÑÎ∞òÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    {sections.map((section) => (
                      <option key={section.sectionId} value={section.sectionId}>
                        {section.courseTitle} (Î∂ÑÎ∞ò {section.sectionId})
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label htmlFor="description">Í≥ºÏ†ú ÏÑ§Î™Ö</label>
                  <textarea
                    id="description"
                    name="description"
                    value={formData.description}
                    onChange={handleInputChange}
                    placeholder="Í≥ºÏ†úÏóê ÎåÄÌïú ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                    rows="4"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label htmlFor="startDate">ÏãúÏûëÏùº</label>
                    <input
                      type="datetime-local"
                      id="startDate"
                      name="startDate"
                      value={formData.startDate}
                      onChange={handleInputChange}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label htmlFor="endDate">ÎßàÍ∞êÏùº</label>
                    <input
                      type="datetime-local"
                      id="endDate"
                      name="endDate"
                      value={formData.endDate}
                      onChange={handleInputChange}
                    />
                  </div>
                </div>

                <div className="form-actions">
                  <button 
                    type="button" 
                    className="btn-secondary"
                    onClick={handleCloseModal}
                  >
                    Ï∑®ÏÜå
                  </button>
                  <button 
                    type="submit" 
                    className="btn-primary"
                  >
                    Í≥ºÏ†ú ÏÉùÏÑ±
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

      </div>
    </AdminLayout>
  );
};

export default AssignmentManagement;
